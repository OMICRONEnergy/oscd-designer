{"version":3,"file":"oscd-designer-first.js","sourceRoot":"","sources":["../oscd-designer-first.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-plusplus */\n/* eslint-disable no-loop-func */\n/* eslint-disable no-nested-ternary */\nimport { LitElement, html, css, svg } from 'lit';\nimport { state, query } from 'lit/decorators.js';\nimport { until } from 'lit/directives/until.js';\n\nimport { newEditEvent } from '@openscd/open-scd-core';\n\n// open-scd editor action for backwards compatibility\nfunction newCreateEvent(parent: Node, element: Node, reference?: Node | null) {\n  return new CustomEvent('editor-action', {\n    bubbles: true,\n    composed: true,\n    detail: { action: { new: { parent, element, reference } } },\n  });\n}\n\ntype Dir = 'horizontal' | 'vertical';\n\nfunction isDir(dir: string | null): dir is Dir {\n  return dir === 'horizontal' || dir === 'vertical';\n}\n\ninterface PositionedElement {\n  x: number;\n  y: number;\n  dir: 'horizontal' | 'vertical';\n  element: Element;\n}\n\nconst sxy = 'http://www.iec.ch/61850/2003/SCLcoordinates';\n\nfunction sxyAttrs(element: Element): { x: number; y: number; dir: Dir } {\n  const x = parseInt(element.getAttributeNS(sxy, 'x') ?? '', 10) || 0;\n  const y = parseInt(element.getAttributeNS(sxy, 'y') ?? '', 10) || 0;\n  const dirAttr = element.getAttributeNS(sxy, 'dir');\n  const dir = isDir(dirAttr) ? dirAttr : 'vertical';\n\n  return { x, y, dir };\n}\n\nfunction positionedElement(element: Element): PositionedElement {\n  const x = parseInt(element.getAttributeNS(sxy, 'x') ?? '', 10) || 0;\n  const y = parseInt(element.getAttributeNS(sxy, 'y') ?? '', 10) || 0;\n  const dirAttr = element.getAttributeNS(sxy, 'dir');\n  const dir = isDir(dirAttr) ? dirAttr : 'vertical';\n\n  return { x, y, dir, element };\n}\n\ninterface Diagram extends PositionedElement {\n  width: number;\n  height: number;\n}\n\ninterface ElementDiagram extends Diagram {\n  label: string;\n  content: ElementDiagram[];\n}\n\nfunction setDimensions<D extends Diagram>(diagram: D, content: Diagram[]): D {\n  const dia = { ...diagram };\n  dia.width = Math.max(...content.map(e => e.x + e.width)) + 2;\n  dia.height = Math.max(...content.map(e => e.y + e.height)) + 2;\n  return dia;\n}\n\ninterface EquipmentDiagram extends Diagram {\n  icon: string;\n}\n\ninterface BayDiagram extends Diagram {\n  equipment: EquipmentDiagram[];\n}\n\nfunction bayDiagram(bay: Element) {\n  const diagram: BayDiagram = {\n    ...positionedElement(bay),\n    width: 2,\n    height: 2,\n    equipment: Array.from(bay.children)\n      .filter(child => child.tagName === 'ConductingEquipment')\n      .map(eq => ({\n        ...positionedElement(eq),\n        width: 1,\n        height: 1,\n        icon: eq.getAttribute('type') || 'general',\n      })),\n  };\n\n  return setDimensions(diagram, diagram.equipment);\n}\n\ninterface VoltageLevelDiagram extends Diagram {\n  bays: BayDiagram[];\n  busBars: Diagram[];\n}\n\nfunction voltageLevelDiagram(voltageLevel: Element) {\n  const diagram: VoltageLevelDiagram = {\n    ...positionedElement(voltageLevel),\n    width: 2,\n    height: 2,\n    bays: [],\n    busBars: [],\n  };\n  for (const bay of Array.from(voltageLevel.children).filter(\n    c => c.tagName === 'Bay'\n  )) {\n    if (!bay.querySelector(':scope > ConductingEquipment'))\n      diagram.busBars.push({\n        ...positionedElement(bay),\n        width: 10,\n        height: 1,\n      });\n    else diagram.bays.push(bayDiagram(bay));\n  }\n  return setDimensions(diagram, diagram.busBars.concat(diagram.bays));\n}\n\ninterface SubstationDiagram extends Diagram {\n  voltageLevels: VoltageLevelDiagram[];\n}\n\nfunction substationDiagram(substation: Element) {\n  const diagram: SubstationDiagram = {\n    ...positionedElement(substation),\n    width: 2,\n    height: 2,\n    voltageLevels: [],\n  };\n\n  Array.from(substation.children)\n    .filter(c => c.tagName === 'VoltageLevel')\n    .forEach(vl => diagram.voltageLevels.push(voltageLevelDiagram(vl)));\n\n  return setDimensions(diagram, diagram.voltageLevels);\n}\n\nfunction renderSubstation(substation: Element) {\n  const diagram = substationDiagram(substation);\n  const { x, y, width, height } = diagram;\n  return svg`<svg x=\"${x}\" y=\"${y}\" width=\"${width}\" height=\"${height}\">\n          <rect x=\"0\" y=\"0\" width=\"100%\" height=\"100%\" fill=\"#cbda\" />\n    </svg>`;\n}\n\nexport default class Designer extends LitElement {\n  @state()\n  doc?: XMLDocument;\n\n  @state()\n  scale = 1;\n\n  @state()\n  top = 0;\n\n  @state()\n  left = 0;\n\n  @state()\n  substationIndex = 0;\n\n  handleMove(evt: MouseEvent) {\n    if (!(evt.buttons % 2)) return;\n    evt.preventDefault();\n    this.left -= (evt.movementX * this.scale) / devicePixelRatio;\n    this.top -= (evt.movementY * this.scale) / devicePixelRatio;\n    if (this.left < 0) this.left = 0;\n    if (this.top < 0) this.top = 0;\n  }\n\n  handleWheel(evt: WheelEvent) {\n    evt.preventDefault();\n    console.warn(this.scale);\n    this.scale += (evt.deltaY * this.scale) / 500;\n    if (this.scale < 0.2) this.scale = 0.2;\n  }\n\n  render() {\n    const substations = Array.from(\n      this.doc?.documentElement.children ?? []\n    ).filter(child => child.tagName === 'Substation');\n    const [x, y, w, h] = [\n      this.left,\n      this.top,\n      100 * this.scale,\n      100 * this.scale,\n    ];\n    return html`\n      <svg\n        @mousemove=${(e: MouseEvent) => this.handleMove(e)}\n        @wheel=${(e: WheelEvent) => this.handleWheel(e)}\n        viewBox=\"${x} ${y} ${w} ${h}\"\n        xmlns=\"http://www.w3.org/2000/svg\"\n      >\n        <pattern\n          id=\"pattern-dots\"\n          x=\"0\"\n          y=\"0\"\n          width=\"3\"\n          height=\"3\"\n          patternUnits=\"userSpaceOnUse\"\n          patternContentUnits=\"userSpaceOnUse\"\n        >\n          <circle\n            id=\"pattern-dot\"\n            cx=\"1.5\"\n            cy=\"1.5\"\n            r=\"0.2\"\n            fill=\"#abcd\"\n          ></circle>\n        </pattern>\n        <rect\n          x=\"0\"\n          y=\"0\"\n          width=\"1000\"\n          height=\"1000\"\n          fill=\"url(#pattern-dots)\"\n        ></rect>\n        ${substations.map(renderSubstation)}\n      </svg>\n    `;\n  }\n\n  static styles = css`\n    svg {\n      margin: 12px;\n      min-height: vmax;\n      min-width: vmax;\n    }\n  `;\n}\n"]}