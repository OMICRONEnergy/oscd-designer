{"version":3,"file":"util.js","sourceRoot":"","sources":["../util.ts"],"names":[],"mappings":"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","sourcesContent":["import { Edit } from '@openscd/open-scd-core';\nimport { getReference } from '@openscd/oscd-scl';\n\nexport const privType = 'Transpower-SLD-Vertices';\nexport const sldNs = 'https://transpower.co.nz/SCL/SSD/SLD/v0';\nexport const xmlnsNs = 'http://www.w3.org/2000/xmlns/';\nexport const svgNs = 'http://www.w3.org/2000/svg';\n\nexport type Point = [number, number];\nexport type Attrs = {\n  pos: Point;\n  dim: Point;\n  label: Point;\n  flip: boolean;\n  rot: 0 | 1 | 2 | 3;\n  bus: boolean;\n};\n\nexport function xmlBoolean(value?: string | null) {\n  return ['true', '1'].includes(value?.trim() ?? 'false');\n}\n\nexport function isBusBar(element: Element) {\n  return (\n    element.tagName === 'Bay' &&\n    xmlBoolean(element.querySelector('Section[bus]')?.getAttribute('bus'))\n  );\n}\n\nexport function attributes(element: Element): Attrs {\n  const [x, y, w, h, rotVal, labelX, labelY] = [\n    'x',\n    'y',\n    'w',\n    'h',\n    'rot',\n    'lx',\n    'ly',\n  ].map(name => parseFloat(element.getAttributeNS(sldNs, name) ?? '0'));\n  const pos = [x, y].map(d => Math.max(0, d)) as Point;\n  const dim = [w, h].map(d => Math.max(1, d)) as Point;\n  const label = [labelX, labelY].map(d => Math.max(0, d)) as Point;\n\n  const bus = xmlBoolean(element.getAttribute('bus'));\n  const flip = xmlBoolean(element.getAttributeNS(sldNs, 'flip'));\n\n  const rot = (((rotVal % 4) + 4) % 4) as 0 | 1 | 2 | 3;\n\n  return { pos, dim, label, flip, rot, bus };\n}\n\nfunction pathString(...args: string[]) {\n  return args.join('/');\n}\n\nexport function elementPath(element: Element, ...rest: string[]): string {\n  const pedigree = [];\n  let child = element;\n  while (child.parentElement && child.hasAttribute('name')) {\n    pedigree.unshift(child.getAttribute('name')!);\n    child = child.parentElement;\n  }\n  return pathString(...pedigree, ...rest);\n}\n\nfunction collinear(v0: Element, v1: Element, v2: Element) {\n  const [[x0, y0], [x1, y1], [x2, y2]] = [v0, v1, v2].map(vertex =>\n    ['x', 'y'].map(name => vertex.getAttributeNS(sldNs, name))\n  );\n  return (x0 === x1 && x1 === x2) || (y0 === y1 && y1 === y2);\n}\n\nexport function removeNode(node: Element): Edit[] {\n  const edits = [] as Edit[];\n\n  if (xmlBoolean(node.querySelector(`Section[bus]`)?.getAttribute('bus'))) {\n    Array.from(node.querySelectorAll('Section:not([bus])')).forEach(section =>\n      edits.push({ node: section })\n    );\n    const sections = Array.from(node.querySelectorAll('Section[bus]'));\n    const busSection = sections[0];\n    Array.from(busSection.children)\n      .slice(1)\n      .forEach(vertex => edits.push({ node: vertex }));\n    const lastVertex = sections[sections.length - 1].lastElementChild;\n    if (lastVertex)\n      edits.push({ parent: busSection, node: lastVertex, reference: null });\n    sections.slice(1).forEach(section => edits.push({ node: section }));\n  } else edits.push({ node });\n\n  Array.from(\n    node.ownerDocument.querySelectorAll(\n      `Terminal[connectivityNode=\"${node.getAttribute('pathName')}\"]`\n    )\n  ).forEach(terminal => edits.push({ node: terminal }));\n\n  return edits;\n}\n\nfunction reverseSection(section: Element): Edit[] {\n  const edits = [] as Edit[];\n\n  Array.from(section.children)\n    .reverse()\n    .forEach(vertex =>\n      edits.push({ parent: section, node: vertex, reference: null })\n    );\n\n  return edits;\n}\n\nfunction healSectionCut(cut: Element): Edit[] {\n  const [x, y] = ['x', 'y'].map(name => cut.getAttributeNS(sldNs, name));\n\n  const isCut = (vertex: Element) =>\n    vertex !== cut &&\n    vertex.getAttributeNS(sldNs, 'x') === x &&\n    vertex.getAttributeNS(sldNs, 'y') === y;\n\n  const cutVertices = Array.from(\n    cut.closest('Private')!.getElementsByTagNameNS(sldNs, 'Section')\n  ).flatMap(section => Array.from(section.children).filter(isCut));\n  const cutSections = cutVertices.map(v => v.parentElement) as Element[];\n\n  if (cutSections.length > 2) return [];\n  if (cutSections.length < 2)\n    return removeNode(cut.closest('ConnectivityNode')!);\n  const [busA, busB] = cutSections.map(section =>\n    xmlBoolean(section.getAttribute('bus'))\n  );\n  if (busA !== busB) return [];\n\n  const edits = [] as Edit[];\n  const [sectionA, sectionB] = cutSections as [Element, Element];\n  if (isCut(sectionA.firstElementChild!)) edits.push(reverseSection(sectionA));\n  const sectionBChildren = Array.from(sectionB.children);\n  if (isCut(sectionB.lastElementChild!)) sectionBChildren.reverse();\n\n  sectionBChildren\n    .slice(1)\n    .forEach(node => edits.push({ parent: sectionA, node, reference: null }));\n\n  const cutA = Array.from(sectionA.children).find(isCut);\n  const neighbourA = isCut(sectionA.firstElementChild!)\n    ? sectionA.children[1]\n    : sectionA.children[sectionA.childElementCount - 2];\n  const neighbourB = sectionBChildren[1];\n  if (\n    neighbourA &&\n    cutA &&\n    neighbourB &&\n    collinear(neighbourA, cutA, neighbourB)\n  )\n    edits.push({ node: cutA });\n  edits.push({ node: sectionB });\n\n  return edits;\n}\n\nfunction updateTerminals(\n  parent: Element,\n  cNode: Element,\n  substationName: string,\n  voltageLevelName: string,\n  bayName: string,\n  cNodeName: string,\n  connectivityNode: string\n) {\n  const updates = [] as Edit[];\n\n  const [oldSubstationName, oldVoltageLevelName, oldBayName] = [\n    'Substation',\n    'VoltageLevel',\n    'Bay',\n  ].map(tag => cNode.closest(tag)?.getAttribute('name') ?? '');\n  const oldCNodeName = cNode.getAttribute('name');\n  const oldConnectivityNode = `${oldSubstationName}/${oldVoltageLevelName}/${oldBayName}/${oldCNodeName}`;\n\n  const terminals = Array.from(\n    parent.ownerDocument.querySelectorAll(\n      `Terminal[substationName=\"${oldSubstationName}\"][voltageLevelName=\"${oldVoltageLevelName}\"][bayName=\"${oldBayName}\"][cNodeName=\"${oldCNodeName}\"], Terminal[connectivityNode=\"${oldConnectivityNode}\"]`\n    )\n  );\n  terminals.forEach(terminal => {\n    updates.push({\n      element: terminal,\n      attributes: {\n        substationName,\n        voltageLevelName,\n        bayName,\n        connectivityNode,\n        cNodeName,\n      },\n    });\n  });\n  return updates;\n}\n\nfunction updateConnectivityNodes(\n  element: Element,\n  parent: Element,\n  name: string\n) {\n  const updates = [] as Edit[];\n\n  const cNodes = Array.from(element.getElementsByTagName('ConnectivityNode'));\n  if (element.tagName === 'ConnectivityNode') cNodes.push(element);\n  const substationName = parent.closest('Substation')!.getAttribute('name');\n  let voltageLevelName = parent.closest('VoltageLevel')?.getAttribute('name');\n  if (element.tagName === 'VoltageLevel') voltageLevelName = name;\n\n  cNodes.forEach(cNode => {\n    let cNodeName = cNode.getAttribute('name');\n    if (element === cNode) cNodeName = name;\n    let bayName = cNode.parentElement?.getAttribute('name') ?? '';\n    if (element.tagName === 'Bay') bayName = name;\n    if (parent.tagName === 'Bay' && parent.hasAttribute('name'))\n      bayName = parent.getAttribute('name')!;\n\n    if (cNodeName && bayName) {\n      const pathName = `${substationName}/${voltageLevelName}/${bayName}/${cNodeName}`;\n      updates.push({\n        element: cNode,\n        attributes: {\n          pathName,\n        },\n      });\n      if (substationName && voltageLevelName && bayName)\n        updates.push(\n          ...updateTerminals(\n            parent,\n            cNode,\n            substationName,\n            voltageLevelName,\n            bayName,\n            cNodeName,\n            pathName\n          )\n        );\n    }\n  });\n  return updates;\n}\n\nfunction uniqueName(element: Element, parent: Element): string {\n  const children = Array.from(parent.children);\n  const oldName = element.getAttribute('name');\n  if (\n    oldName &&\n    !children.find(child => child.getAttribute('name') === oldName)\n  )\n    return oldName;\n\n  const baseName =\n    element.getAttribute('name')?.replace(/[0-9]*$/, '') ??\n    element.tagName.charAt(0);\n  let index = 1;\n  function hasName(child: Element) {\n    return child.getAttribute('name') === baseName + index.toString();\n  }\n  while (children.find(hasName)) index += 1;\n\n  return baseName + index.toString();\n}\n\nexport function reparentElement(element: Element, parent: Element): Edit[] {\n  const edits: Edit[] = [];\n  edits.push({\n    node: element,\n    parent,\n    reference: getReference(parent, element.tagName),\n  });\n  const newName = uniqueName(element, parent);\n  if (newName !== element.getAttribute('name'))\n    edits.push({ element, attributes: { name: newName } });\n  edits.push(...updateConnectivityNodes(element, parent, newName));\n  return edits;\n}\n\nexport function removeTerminal(terminal: Element): Edit[] {\n  const edits = [] as Edit[];\n\n  edits.push({ node: terminal });\n  const pathName = terminal.getAttribute('connectivityNode');\n  const cNode = terminal.ownerDocument.querySelector(\n    `ConnectivityNode[pathName=\"${pathName}\"]`\n  );\n\n  const otherTerminals = Array.from(\n    terminal.ownerDocument.querySelectorAll(\n      `Terminal[connectivityNode=\"${pathName}\"]`\n    )\n  ).filter(t => t !== terminal);\n\n  if (\n    cNode &&\n    otherTerminals.length &&\n    otherTerminals.some(t => t.closest('Bay')) &&\n    otherTerminals.every(t => t.closest('Bay') !== cNode.closest('Bay')) &&\n    !isBusBar(cNode.closest('Bay')!)\n  ) {\n    const newParent = otherTerminals\n      .find(t => t.closest('Bay'))!\n      .closest('Bay');\n    if (newParent) edits.push(...reparentElement(cNode, newParent));\n  }\n\n  const priv = cNode?.querySelector(`Private[type=\"${privType}\"]`);\n  const vertex = priv?.querySelector(\n    `Vertex[*|uuid=\"${terminal.getAttributeNS(sldNs, 'uuid')}\"]`\n  );\n  const section = vertex?.parentElement;\n  if (!section) return edits;\n  edits.push({ node: section });\n\n  const cut =\n    vertex === section.lastElementChild\n      ? section.firstElementChild\n      : section.lastElementChild;\n\n  if (cut) edits.push(...healSectionCut(cut));\n\n  return edits;\n}\n\nexport function connectionStartPoints(equipment: Element): {\n  top: { close: Point; far: Point };\n  bottom: { close: Point; far: Point };\n} {\n  const {\n    pos: [x, y],\n    rot,\n  } = attributes(equipment);\n\n  const top = {\n    close: [\n      [x + 0.5, y],\n      [x + 1, y + 0.5],\n      [x + 0.5, y + 1],\n      [x, y + 0.5],\n    ][rot] as Point,\n    far: [\n      [x + 0.5, y - 0.5],\n      [x + 1.5, y + 0.5],\n      [x + 0.5, y + 1.5],\n      [x - 0.5, y + 0.5],\n    ][rot] as Point,\n  };\n  const bottom = {\n    close: [\n      [x + 0.5, y + 1],\n      [x, y + 0.5],\n      [x + 0.5, y],\n      [x + 1, y + 0.5],\n    ][rot] as Point,\n    far: [\n      [x + 0.5, y + 1.5],\n      [x - 0.5, y + 0.5],\n      [x + 0.5, y - 0.5],\n      [x + 1.5, y + 0.5],\n    ][rot] as Point,\n  };\n\n  return { top, bottom };\n}\n\nexport type ResizeDetail = {\n  w: number;\n  h: number;\n  element: Element;\n};\nexport type ResizeEvent = CustomEvent<ResizeDetail>;\nexport function newResizeEvent(detail: ResizeDetail): ResizeEvent {\n  return new CustomEvent('oscd-sld-resize', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\n\nexport type PlaceLabelDetail = {\n  x: number;\n  y: number;\n  element: Element;\n};\nexport type PlaceDetail = {\n  x: number;\n  y: number;\n  element: Element;\n  parent: Element;\n};\nexport type PlaceEvent = CustomEvent<PlaceDetail>;\nexport function newPlaceEvent(detail: PlaceDetail): PlaceEvent {\n  return new CustomEvent('oscd-sld-place', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\n\nexport type PlaceLabelEvent = CustomEvent<PlaceLabelDetail>;\nexport function newPlaceLabelEvent(detail: PlaceLabelDetail): PlaceLabelEvent {\n  return new CustomEvent('oscd-sld-place-label', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\n\nexport type ConnectDetail = {\n  equipment: Element;\n  path: Point[];\n  terminal: 'top' | 'bottom';\n  connectTo: Element;\n  toTerminal?: 'top' | 'bottom';\n};\nexport type ConnectEvent = CustomEvent<ConnectDetail>;\nexport function newConnectEvent(detail: ConnectDetail): ConnectEvent {\n  return new CustomEvent('oscd-sld-connect', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\nexport type StartEvent = CustomEvent<Element>;\nexport function newRotateEvent(detail: Element): StartEvent {\n  return new CustomEvent('oscd-sld-rotate', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\nexport function newStartResizeEvent(detail: Element): StartEvent {\n  return new CustomEvent('oscd-sld-start-resize', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\nexport function newStartPlaceEvent(detail: Element): StartEvent {\n  return new CustomEvent('oscd-sld-start-place', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\nexport function newStartPlaceLabelEvent(detail: Element): StartEvent {\n  return new CustomEvent('oscd-sld-start-place-label', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\nexport type StartConnectDetail = {\n  equipment: Element;\n  terminal: 'top' | 'bottom';\n};\nexport type StartConnectEvent = CustomEvent<StartConnectDetail>;\nexport function newStartConnectEvent(\n  detail: StartConnectDetail\n): StartConnectEvent {\n  return new CustomEvent('oscd-sld-start-connect', {\n    bubbles: true,\n    composed: true,\n    detail,\n  });\n}\n\ndeclare global {\n  interface ElementEventMap {\n    ['oscd-sld-resize']: ResizeEvent;\n    ['oscd-sld-place']: PlaceEvent;\n    ['oscd-sld-place-label']: PlaceLabelEvent;\n    ['oscd-sld-connect']: ConnectEvent;\n    ['oscd-sld-rotate']: StartEvent;\n    ['oscd-sld-start-resize']: StartEvent;\n    ['oscd-sld-start-place']: StartEvent;\n    ['oscd-sld-start-place-label']: StartEvent;\n    ['oscd-sld-start-connect']: StartConnectEvent;\n  }\n}\n"]}