{"version":3,"file":"oscd-designer-nogrid.js","sourceRoot":"","sources":["../oscd-designer-nogrid.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable lit-a11y/click-events-have-key-events */\n/* eslint-disable @typescript-eslint/no-unused-vars */\nimport { LitElement, html, css } from 'lit';\nimport { state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\n\nimport { newEditEvent } from '@openscd/open-scd-core';\n\n/*\n// open-scd editor action for backwards compatibility\nfunction newCreateEvent(parent: Node, element: Node, reference?: Node | null) {\n  return new CustomEvent('editor-action', {\n    bubbles: true,\n    composed: true,\n    detail: { action: { new: { parent, element, reference } } },\n  });\n}\n*/\n\nconst sldNs = 'https://transpower.com/SCL/SSD/SLD/v0';\nconst gridSize = 24;\n\nconst dirs = ['E', 'S', 'W', 'N'] as const;\n\ntype Dir = (typeof dirs)[number];\n\ntype Attrs = {\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n  dir: Dir;\n  bus: boolean;\n};\n\nfunction direction(str: string | null): Dir {\n  const dir = str?.toUpperCase();\n  if (dirs.includes(dir as Dir)) return dir as Dir;\n  return 'S';\n}\n\nconst clockwise: Record<Dir, Dir> = { E: 'S', S: 'W', W: 'N', N: 'E' };\n\nfunction attributes(element: Element): Attrs {\n  const [x, y, w, h] = ['x', 'y', 'w', 'h'].map(name =>\n    parseInt(element.getAttributeNS(sldNs, name) ?? '1', 10)\n  );\n  const dir = direction(element.getAttributeNS(sldNs, 'dir'));\n  const bus = ['true', '1'].includes(\n    element.getAttributeNS(sldNs, 'bus')?.trim() ?? 'false'\n  );\n\n  return { x, y, w, h, dir, bus };\n}\n\nconst children: Partial<Record<string, string[]>> = {\n  SCL: ['Substation'],\n  Substation: ['VoltageLevel'],\n  VoltageLevel: ['Bay'],\n  Bay: ['ConductingEquipment', 'Terminal'],\n};\n\nfunction canContain(parent: Element, child: Element | undefined): boolean {\n  return children[parent.tagName]?.includes(child?.tagName ?? '') ?? false;\n}\n\nexport default class Designer extends LitElement {\n  @state()\n  doc?: XMLDocument;\n\n  @state()\n  editCount = -1;\n\n  created = 0;\n\n  /*\n  moveTo(x: number, y: number, parent: Element) {\n    console.log('moving', this.placing, 'to', parent, x, y);\n    if (!this.placing) return;\n    if (\n      this.placing.parentElement !== parent &&\n      this.placing.tagName !== 'Terminal'\n    )\n      this.dispatchEvent(newEditEvent({ node: this.placing, parent }));\n    this.dispatchEvent(\n      newEditEvent({\n        element: this.placing,\n        attributes: {\n          x: { namespaceURI: sldNs, value: x.toString() },\n          y: { namespaceURI: sldNs, value: y.toString() },\n        },\n      })\n    );\n  }\n\n  createAt(x: number, y: number, parent: Element) {\n    if (!this.placing) return;\n    this.placing.setAttributeNS(sldNs, 'x', x.toString());\n    this.placing.setAttributeNS(sldNs, 'y', y.toString());\n    this.placing.setAttributeNS(sldNs, 'w', '5');\n    this.placing.setAttributeNS(sldNs, 'h', '5');\n    this.placing.setAttribute('name', this.placing.tagName + this.created);\n    this.created += 1;\n    this.dispatchEvent(newEditEvent({ node: this.placing, parent }));\n  }\n\n  placeAt(x: number, y: number, parent: Element) {\n    if (!this.placing) return;\n    if (this.placing.parentElement) this.moveTo(x, y, parent);\n    else this.createAt(x, y, parent);\n    this.placing = undefined;\n  }\n\n  place(element: Element | undefined) {\n    console.log('placing', element);\n    this.resizing = undefined;\n    this.placing = element;\n  }\n\n  resizeTo(targetX: number, targetY: number) {\n    if (!this.resizing) return;\n    const { x, y } = attributes(this.resizing);\n    const w = Math.max(1, targetX - x + 1).toString();\n    const h = Math.max(1, targetY - y + 1).toString();\n    this.dispatchEvent(\n      newEditEvent({\n        element: this.resizing,\n        attributes: {\n          w: { namespaceURI: sldNs, value: w },\n          h: { namespaceURI: sldNs, value: h },\n        },\n      })\n    );\n    this.resizing = undefined;\n  }\n\n  rotate(element: Element | undefined) {\n    if (!element) return;\n    const { dir } = attributes(element);\n\n    this.dispatchEvent(\n      newEditEvent({\n        element,\n        attributes: {\n          dir: { namespaceURI: sldNs, value: clockwise[dir] },\n        },\n      })\n    );\n  }\n   */\n\n  renderEquipment(equipment: Element) {\n    console.log(this);\n    const { x, y, dir } = attributes(equipment);\n    const [input, output] = Array.from(equipment.children ?? []).filter(\n      child => child.tagName === 'Terminal'\n    );\n    let [inX, outX, inY, outY] = [x, x, y, y];\n    if (dir === 'S') {\n      inY -= 1;\n      outY += 1;\n    } else if (dir === 'N') {\n      inY += 1;\n      outY -= 1;\n    } else if (dir === 'E') {\n      inX -= 1;\n      outX += 1;\n    } else if (dir === 'W') {\n      inX += 1;\n      outX -= 1;\n    }\n\n    const inTerminal = input\n      ? html`<div\n          class=\"clickable terminal\"\n          style=\"grid-column: ${inX}; grid-row: ${inY};\"\n        >\n          <abbr title=\"${input.getAttribute('connectivityNode')}\"\n            >${input.getAttribute('cNodeName')}</abbr\n          >\n        </div>`\n      : undefined;\n    const outTerminal = output\n      ? html`<div\n          class=\"clickable terminal\"\n          style=\"grid-column: ${outX}; grid-row: ${outY};\"\n        >\n          <abbr title=\"${output.getAttribute('connectivityNode')}\"\n            >${output.getAttribute('cNodeName')}</abbr\n          >\n        </div>`\n      : undefined;\n\n    return html`<div\n        class=\"clickable equipment\"\n        style=\"grid-column: ${x}; grid-row: ${y};\"\n      >\n        <abbr title=${equipment.getAttribute('name')}\n          >${equipment.getAttribute('type')}</abbr\n        >\n      </div>\n      ${inTerminal} ${outTerminal}`;\n  }\n\n  renderBay(bay: Element) {\n    const { x, y, w, h, bus } = attributes(bay);\n    const equipment = Array.from(bay.children ?? []).filter(\n      child => child.tagName === 'ConductingEquipment'\n    );\n\n    return html`<section\n      class=\"${classMap({\n        bus,\n        bay: !bus,\n      })}\"\n      style=\"grid-column: ${x} / span ${w}; grid-row: ${y} / span ${h};\"\n    >\n      <span\n        class=\"clickable label\"\n        @contextmenu=${(e: MouseEvent) => {\n          e.preventDefault();\n        }}\n      >\n        ${bay.getAttribute('name')}\n      </span>\n      ${equipment.map(e => this.renderEquipment(e))}\n    </section>`;\n  }\n\n  renderVoltageLevel(voltageLevel: Element) {\n    const { x, y, w, h } = attributes(voltageLevel);\n    const bays = Array.from(voltageLevel.children ?? []).filter(\n      child => child.tagName === 'Bay'\n    );\n\n    return html`<section\n      class=\"voltagelevel\"\n      style=\"grid-column: ${x} / span ${w}; grid-row: ${y} / span ${h};\"\n    >\n      <span class=\"clickable label\">${voltageLevel.getAttribute('name')}</span>\n      ${bays.map(b => this.renderBay(b))}\n    </section>`;\n  }\n\n  renderSubstation(substation: Element) {\n    const { x, y, w, h } = attributes(substation);\n    const voltageLevels = Array.from(substation.children ?? []).filter(\n      child => child.tagName === 'VoltageLevel'\n    );\n\n    return html`<section\n      class=\"substation\"\n      style=\"grid-column: ${x} / span ${w}; grid-row: ${y} / span ${h};\"\n    >\n      <span class=\"clickable label\">${substation.getAttribute('name')}</span>\n      ${voltageLevels.map(vl => this.renderVoltageLevel(vl))}\n    </section>`;\n  }\n\n  render() {\n    const substations = Array.from(\n      this.doc?.documentElement.children ?? []\n    ).filter(\n      child =>\n        child.tagName === 'Substation' &&\n        Array.from(child.attributes)\n          .map(a => a.value)\n          .includes(sldNs)\n    );\n\n    return html` <menu>\n        <li>\n          <button\n            @click=${() => {\n              const substation = this.doc?.createElement('Substation');\n              substation?.setAttribute('xmlns:esld', sldNs);\n            }}\n          >\n            S\n          </button>\n        </li>\n        <li>\n          <button>V</button>\n        </li>\n        <li>\n          <button>B</button>\n        </li>\n        <li>\n          <button>E</button>\n        </li>\n        <li>\n          <button>X</button>\n        </li>\n      </menu>\n      <main>${substations.map(s => this.renderSubstation(s))}</main>`;\n  }\n\n  static styles = css`\n    menu {\n      position: fixed;\n      bottom: 20px;\n      left: 20px;\n      list-style-type: none;\n      display: flex;\n      padding: 0;\n      margin: 0;\n      gap: 5px;\n      z-index: 100;\n    }\n  `;\n}\n"]}